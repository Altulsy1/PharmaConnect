<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
    <meta name="theme-color" content="#2a9d8f"/>
    <meta name="description" content="PharmaConnect - نظام إدارة الصيدليات الذكي"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PharmaConnect">
    <link rel="apple-touch-icon" href="#">
    <title>PharmaConnect - نظام إدارة الصيدليات</title>
    
    <!-- Font Awesome 6 (مجاني) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
    
    <!-- Leaflet CSS -->
    <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
    
    <!-- Google Fonts - تحديث الخطوط -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;500;600;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ===== متغيرات وتصميم عصري ===== */
        :root {
            /* نظام الألوان - محدث عصري */
            --primary-gradient: linear-gradient(135deg, #2a9d8f 0%, #21867a 100%);
            --secondary-gradient: linear-gradient(135deg, #264653 0%, #1a3340 100%);
            --accent-gradient: linear-gradient(135deg, #e9c46a 0%, #f4d03f 100%);
            
            --primary-color: #2a9d8f;
            --primary-dark: #21867a;
            --primary-light: #e8f5f3;
            --secondary-color: #264653;
            --accent-color: #e9c46a;
            --danger-color: #e76f51;
            --warning-color: #f4a261;
            --success-color: #2a9d8f;
            --info-color: #4cc9f0;
            
            --user-color: #4cc9f0;
            --pharmacy-color: #7209b7;
            --pharmacy-gradient: linear-gradient(135deg, #7209b7 0%, #5a0d8c 100%);
            
            /* ألوان محايدة */
            --bg-color: #f8fafc;
            --surface-color: #ffffff;
            --surface-hover: #f1f5f9;
            --border-color: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            
            /* ظلال محدثة */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --shadow-inner: inset 0 2px 4px 0 rgb(0 0 0 / 0.05);
            
            /* أشكال محدثة */
            --radius-xs: 6px;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-full: 9999px;
            
            /* خطوط محدثة */
            --font-arabic: 'IBM Plex Sans Arabic', 'Tajawal', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-numbers: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            
            /* تحسينات الجوال */
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
            
            --nav-height: 64px;
            --bottom-nav-height: 70px;
            
            /* انتقالات سلسة */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ===== إعادة تعيين متقدمة ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        *::before,
        *::after {
            box-sizing: border-box;
        }
        
        html {
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
            scroll-behavior: smooth;
        }
        
        body {
            font-family: var(--font-arabic);
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.5;
            direction: rtl;
            overflow-x: hidden;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* ===== تصميم عصري للهيدر ===== */
        .app-header {
            background: var(--primary-gradient);
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 0.5rem 0;
            padding-top: calc(0.5rem + var(--safe-top));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: var(--shadow-md);
            transition: var(--transition-base);
        }
        
        .app-header.scrolled {
            padding: 0.25rem 0;
            padding-top: calc(0.25rem + var(--safe-top));
            background: linear-gradient(135deg, rgba(42, 157, 143, 0.98) 0%, rgba(33, 134, 122, 0.98) 100%);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        
        /* ===== تصميم اللوجو عصري ===== */
        .logo-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow-sm);
        }
        
        .logo-icon i {
            font-size: 1.4rem;
            color: var(--accent-color);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        
        .logo-text h1 {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            line-height: 1.2;
            background: linear-gradient(to right, #ffffff, #f0f9ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .slogan {
            font-size: 0.8rem;
            opacity: 0.9;
            color: rgba(255, 255, 255, 0.95);
            font-weight: 400;
        }
        
        /* ===== تحكمات المستخدم ===== */
        .user-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-icon {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .btn-icon:hover,
        .btn-icon:active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0.95);
        }
        
        .btn-icon i {
            font-size: 1.2rem;
        }
        
        .user-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            padding: 6px 12px 6px 6px;
            border-radius: var(--radius-full);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--secondary-color);
            font-size: 1rem;
            box-shadow: var(--shadow-sm);
        }
        
        /* ===== زر القائمة الجوال ===== */
        .mobile-menu-btn {
            display: none;
            width: 44px;
            height: 44px;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        /* ===== زر الإجراء الرئيسي للجوال ===== */
        .mobile-fab {
            display: none;
            position: fixed;
            bottom: 24px;
            left: 24px;
            z-index: 90;
            width: 56px;
            height: 56px;
            border-radius: var(--radius-full);
            background: var(--primary-gradient);
            box-shadow: var(--shadow-lg);
            color: white;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: var(--transition-base);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .mobile-fab i {
            font-size: 1.5rem;
        }
        
        .mobile-fab:active {
            transform: scale(0.9);
            box-shadow: var(--shadow-md);
        }
        
        /* ===== الحاوية الرئيسية ===== */
        .app-main {
            max-width: 1200px;
            margin: 16px auto;
            padding: 0 16px;
            display: flex;
            gap: 20px;
            min-height: calc(100vh - 120px);
            position: relative;
        }
        
        /* ===== تصميم الشريط الجانبي - بطاقات ===== */
        .pharma-sidebar {
            width: 360px;
            flex-shrink: 0;
            transition: var(--transition-base);
        }
        
        .sidebar-card {
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            transition: var(--transition-base);
        }
        
        .sidebar-card:hover {
            box-shadow: var(--shadow-lg);
        }
        
        .card-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(to right, var(--primary-light), transparent);
        }
        
        .card-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            color: var(--secondary-color);
            margin: 0;
        }
        
        .card-header h3 i {
            color: var(--primary-color);
            font-size: 1.3rem;
        }
        
        .card-body {
            padding: 20px;
        }
        
        /* ===== محدد نوع المستخدم - تصميم Tabs ===== */
        .user-tabs {
            display: flex;
            gap: 8px;
            padding: 8px;
            background: var(--bg-color);
            border-radius: var(--radius-xl);
            margin-bottom: 20px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: var(--radius-lg);
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: var(--transition-fast);
            font-family: var(--font-arabic);
        }
        
        .tab-btn i {
            font-size: 1.1rem;
        }
        
        .tab-btn.active {
            background: var(--surface-color);
            color: var(--primary-color);
            box-shadow: var(--shadow-sm);
        }
        
        .tab-btn[data-type="patient"].active {
            color: var(--user-color);
        }
        
        .tab-btn[data-type="pharmacy"].active {
            color: var(--pharmacy-color);
        }
        
        /* ===== بطاقة الموقع ===== */
        .location-badge {
            background: linear-gradient(135deg, #f0f9ff, #e6f7ff);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-right: 4px solid var(--user-color);
        }
        
        .location-badge i {
            font-size: 1.3rem;
            color: var(--user-color);
            background: white;
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
        }
        
        .location-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* ===== منزلق النطاق العصري ===== */
        .range-container {
            background: var(--bg-color);
            padding: 16px;
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
        }
        
        .range-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .range-label span {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .range-value-badge {
            background: var(--primary-gradient);
            color: white;
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .modern-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, var(--primary-color) 0%, var(--primary-color) 50%, var(--border-color) 50%);
            border-radius: var(--radius-full);
            outline: none;
        }
        
        .modern-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: var(--radius-full);
            background: white;
            border: 2px solid var(--primary-color);
            box-shadow: 0 2px 8px rgba(42, 157, 143, 0.3);
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .modern-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(42, 157, 143, 0.4);
        }
        
        /* ===== حقل البحث العصري ===== */
        .search-field {
            position: relative;
            margin-bottom: 16px;
        }
        
        .search-input {
            width: 100%;
            padding: 16px 48px 16px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-full);
            font-size: 1rem;
            font-family: var(--font-arabic);
            background: white;
            transition: var(--transition-fast);
        }
        
        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(42, 157, 143, 0.1);
            outline: none;
        }
        
        .search-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1.2rem;
        }
        
        /* ===== أزرار عصري ===== */
        .btn-modern {
            padding: 14px 24px;
            border: none;
            border-radius: var(--radius-full);
            font-weight: 600;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: var(--transition-base);
            font-family: var(--font-arabic);
            min-height: 52px;
            width: 100%;
            letter-spacing: 0.5px;
        }
        
        .btn-primary-modern {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 8px 16px -4px rgba(42, 157, 143, 0.3);
        }
        
        .btn-primary-modern:hover,
        .btn-primary-modern:active {
            transform: translateY(-2px);
            box-shadow: 0 12px 20px -6px rgba(42, 157, 143, 0.4);
        }
        
        .btn-pharmacy-modern {
            background: var(--pharmacy-gradient);
            color: white;
            box-shadow: 0 8px 16px -4px rgba(114, 9, 183, 0.3);
        }
        
        .btn-outline-modern {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .btn-outline-modern:hover {
            background: var(--bg-color);
            border-color: var(--primary-color);
        }
        
        /* ===== بطاقات الصيدليات ===== */
        .pharmacy-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
            max-height: 400px;
            overflow-y: auto;
            padding: 4px;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--border-color);
        }
        
        .pharmacy-grid::-webkit-scrollbar {
            width: 6px;
        }
        
        .pharmacy-grid::-webkit-scrollbar-track {
            background: var(--border-color);
            border-radius: var(--radius-full);
        }
        
        .pharmacy-grid::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: var(--radius-full);
        }
        
        .pharmacy-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 16px;
            border: 1px solid var(--border-color);
            transition: var(--transition-base);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .pharmacy-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-color);
            border-radius: var(--radius-full);
            opacity: 0;
            transition: var(--transition-base);
        }
        
        .pharmacy-card:hover::before,
        .pharmacy-card.active::before {
            opacity: 1;
        }
        
        .pharmacy-card:hover {
            transform: translateX(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }
        
        .pharmacy-card.active {
            background: linear-gradient(to right, var(--primary-light), white);
            border-color: var(--primary-color);
        }
        
        .pharmacy-name {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .pharmacy-name h4 {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }
        
        .pharmacy-distance {
            background: var(--bg-color);
            padding: 4px 10px;
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .pharmacy-address {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .medicine-stock {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed var(--border-color);
        }
        
        .stock-chip {
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .stock-high {
            background: #dcfce7;
            color: #166534;
        }
        
        .stock-medium {
            background: #fef9c3;
            color: #854d0e;
        }
        
        .stock-low {
            background: #ffedd5;
            color: #9a3412;
        }
        
        .stock-out {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* ===== حاوية الخريطة ===== */
        .map-wrapper {
            flex: 1;
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 100px;
            height: calc(100vh - 140px);
            min-height: 500px;
            border: 1px solid var(--border-color);
        }
        
        #map {
            height: 100%;
            width: 100%;
            background: var(--bg-color);
        }
        
        /* ===== دليل الخريطة العصري ===== */
        .map-legend {
            position: absolute;
            bottom: 24px;
            left: 24px;
            z-index: 10;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            padding: 16px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 240px;
            transition: var(--transition-base);
        }
        
        .map-legend.collapsed {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-full);
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: var(--primary-gradient);
        }
        
        .map-legend.collapsed h3,
        .map-legend.collapsed .legend-items {
            display: none;
        }
        
        .map-legend.collapsed::after {
            content: '\f3c5';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: white;
            font-size: 1.5rem;
        }
        
        .map-legend h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            margin-bottom: 12px;
            color: var(--text-primary);
        }
        
        .legend-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: var(--radius-full);
        }
        
        /* ===== تصميم الجوال المتجاوب ===== */
        @media (max-width: 992px) {
            .app-main {
                flex-direction: column;
                padding: 0 0 80px 0;
                margin: 0;
                max-width: 100%;
                gap: 0;
            }
            
            .pharma-sidebar {
                width: 100%;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                top: auto;
                z-index: 50;
                transform: translateY(calc(100% - 80px));
                transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                box-shadow: var(--shadow-xl);
                border-radius: var(--radius-xl) var(--radius-xl) 0 0;
                background: white;
                max-height: 80vh;
                overflow-y: auto;
                padding-bottom: var(--safe-bottom);
            }
            
            .pharma-sidebar.open {
                transform: translateY(0);
            }
            
            .sidebar-card {
                border-radius: 0;
                box-shadow: none;
                background: white;
            }
            
            .map-wrapper {
                position: relative;
                top: 0;
                height: 60vh;
                min-height: 500px;
                border-radius: 0;
                margin-bottom: 0;
                border: none;
            }
            
            .mobile-menu-btn {
                display: flex;
            }
            
            .mobile-fab {
                display: flex;
            }
            
            .user-chip {
                display: none;
            }
            
            .logo-text .slogan {
                display: none;
            }
            
            .logo-text h1 {
                font-size: 1.2rem;
            }
            
            .logo-icon {
                width: 36px;
                height: 36px;
            }
            
            .logo-icon i {
                font-size: 1.2rem;
            }
            
            /* مؤشر سحب الشريط الجانبي */
            .sidebar-drag-handle {
                display: flex;
                justify-content: center;
                padding: 12px 0 8px;
                position: sticky;
                top: 0;
                background: white;
                z-index: 5;
                border-bottom: 1px solid var(--border-color);
            }
            
            .drag-indicator {
                width: 48px;
                height: 5px;
                background: var(--border-color);
                border-radius: var(--radius-full);
            }
            
            .map-legend {
                bottom: 100px;
            }
        }
        
        @media (max-width: 480px) {
            .map-wrapper {
                height: 50vh;
                min-height: 400px;
            }
            
            .btn-icon {
                width: 40px;
                height: 40px;
            }
            
            .logo-text h1 {
                font-size: 1rem;
            }
            
            .pharma-sidebar {
                transform: translateY(calc(100% - 70px));
            }
            
            .card-body {
                padding: 16px;
            }
            
            .user-tabs .tab-btn span {
                display: none;
            }
            
            .user-tabs .tab-btn i {
                font-size: 1.3rem;
                margin: 0;
            }
            
            .user-tabs .tab-btn {
                padding: 12px;
            }
            
            .map-legend {
                bottom: 90px;
                left: 16px;
                max-width: 200px;
            }
        }
        
        /* ===== أنيميشنات ===== */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in {
            animation: slideIn 0.4s ease-out;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        /* ===== إشعارات عصري ===== */
        .modern-toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 2000;
            transform: translateX(150%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 350px;
            border-right: 4px solid var(--primary-color);
        }
        
        .modern-toast.show {
            transform: translateX(0);
        }
        
        .toast-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .toast-message {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* ===== شاشة التحميل ===== */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 3000;
            gap: 20px;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: var(--radius-full);
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- الهيدر العصري -->
    <header class="app-header" id="appHeader">
        <div class="header-content">
            <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="فتح القائمة">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="logo-wrapper">
                <div class="logo-icon">
                    <i class="fas fa-pills"></i>
                </div>
                <div class="logo-text">
                    <h1>PharmaConnect</h1>
                    <span class="slogan">دواؤك أقرب مما تتخيل...</span>
                </div>
            </div>
            
            <div class="user-actions">
                <button class="btn-icon" id="aboutBtn" aria-label="عن الخدمة">
                    <i class="fas fa-circle-info"></i>
                </button>
                <button class="btn-icon" id="langToggleBtn" aria-label="تغيير اللغة">
                    <span style="font-size: 0.9rem;">EN</span>
                </button>
                
                <div class="user-chip" id="userChip" style="display: none;">
                    <div class="avatar" id="userAvatar">م</div>
                    <span id="userName" style="font-size: 0.9rem;">مستخدم</span>
                </div>
                
                <button class="btn-icon" id="logoutBtn" style="display: none;" aria-label="تسجيل الخروج">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- الخلفية للشريط الجانبي في الجوال -->
    <div class="sidebar-backdrop" id="sidebarBackdrop" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 45;"></div>

    <!-- المحتوى الرئيسي -->
    <main class="app-main">
        <!-- الشريط الجانبي - تصميم بطاقة -->
        <div class="pharma-sidebar" id="pharmaSidebar">
            <!-- مؤشر السحب للجوال -->
            <div class="sidebar-drag-handle" id="dragHandle">
                <div class="drag-indicator"></div>
            </div>
            
            <div class="sidebar-card">
                <!-- أزرار التبديل العصري -->
                <div class="user-tabs">
                    <button class="tab-btn active" data-type="patient" id="patientTabBtn">
                        <i class="fas fa-user-injured"></i>
                        <span>مريض</span>
                    </button>
                    <button class="tab-btn" data-type="pharmacy" id="pharmacyTabBtn">
                        <i class="fas fa-store"></i>
                        <span>صيدلية</span>
                    </button>
                </div>
                
                <!-- لوحة المريض -->
                <div class="panel patient-panel active" id="patientPanel">
                    <div class="card-body">
                        <!-- بطاقة الموقع -->
                        <div class="location-badge" id="locationInfo">
                            <i class="fas fa-location-dot"></i>
                            <div>
                                <div style="font-weight: 700; margin-bottom: 4px;">موقعك الحالي</div>
                                <span class="location-text" id="locationText">جاري تحديد موقعك...</span>
                            </div>
                        </div>
                        
                        <!-- منزلق النطاق العصري -->
                        <div class="range-container">
                            <div class="range-label">
                                <span>نطاق البحث</span>
                                <span class="range-value-badge"><span id="radiusValue">5</span> كم</span>
                            </div>
                            <input type="range" class="modern-slider" id="searchRadius" min="1" max="20" value="5" step="1">
                        </div>
                        
                        <!-- حقل البحث -->
                        <div class="search-field">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" id="medicineSearch" placeholder="ابحث عن دواء..." autocomplete="off">
                            <div class="search-suggestions" id="searchSuggestions" style="position: absolute; top: 100%; right: 0; left: 0; background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg; z-index: 10; display: none;"></div>
                        </div>
                        
                        <!-- زر البحث -->
                        <button class="btn-modern btn-primary-modern" id="searchBtn">
                            <i class="fas fa-search"></i>
                            ابحث عن الدواء
                        </button>
                        
                        <!-- اقتراحات سريعة -->
                        <div style="display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap;">
                            <span style="color: var(--text-muted); font-size: 0.85rem;">أدوية شائعة:</span>
                            <span class="sample-med" style="background: var(--bg-color); padding: 4px 12px; border-radius: var(--radius-full); font-size: 0.85rem; cursor: pointer;">أموكسيسيلين</span>
                            <span class="sample-med" style="background: var(--bg-color); padding: 4px 12px; border-radius: var(--radius-full); font-size: 0.85rem; cursor: pointer;">ميتفورمين</span>
                            <span class="sample-med" style="background: var(--bg-color); padding: 4px 12px; border-radius: var(--radius-full); font-size: 0.85rem; cursor: pointer;">باراسيتامول</span>
                        </div>
                        
                        <!-- نتائج البحث -->
                        <div id="patientResults" style="margin-top: 24px; display: none;">
                            <h4 style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <span>الصيدليات المتاحة</span>
                                <span style="background: var(--bg-color); padding: 4px 12px; border-radius: var(--radius-full); font-size: 0.85rem;" id="resultCount"></span>
                            </h4>
                            <div class="pharmacy-grid" id="pharmacyResults"></div>
                        </div>
                        
                        <!-- أحدث الصيدليات -->
                        <div style="margin-top: 24px;">
                            <h4 style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                                <i class="fas fa-clock" style="color: var(--primary-color);"></i>
                                أحدث الصيدليات
                            </h4>
                            <div class="pharmacy-grid" id="recentPharmaciesList"></div>
                        </div>
                    </div>
                </div>
                
                <!-- لوحة الصيدلية -->
                <div class="panel pharmacy-panel" id="pharmacyPanel" style="display: none;">
                    <div class="card-body">
                        <!-- نماذج المصادقة -->
                        <div id="loginForm" class="auth-form active">
                            <h4 style="margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-sign-in-alt" style="color: var(--pharmacy-color);"></i>
                                تسجيل الدخول
                            </h4>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">البريد الإلكتروني</label>
                                <input type="email" class="search-input" id="loginEmail" placeholder="pharmacy@example.com" style="border-radius: var(--radius-lg);">
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">كلمة المرور</label>
                                <div style="position: relative;">
                                    <input type="password" class="search-input" id="loginPassword" placeholder="••••••••" style="border-radius: var(--radius-lg); padding-left: 50px;">
                                    <button type="button" id="toggleLoginPassword" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer;">
                                        <i class="far fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <button class="btn-modern btn-pharmacy-modern" id="loginBtn">
                                <i class="fas fa-sign-in-alt"></i>
                                دخول
                            </button>
                            
                            <div style="text-align: center; margin-top: 16px;">
                                <span style="color: var(--text-secondary);">ليس لديك حساب؟</span>
                                <button id="showRegister" style="background: none; border: none; color: var(--pharmacy-color); font-weight: 700; cursor: pointer;">سجل الآن</button>
                            </div>
                        </div>
                        
                        <div id="registerForm" class="auth-form" style="display: none;">
                            <h4 style="margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-store-alt" style="color: var(--pharmacy-color);"></i>
                                تسجيل صيدلية جديدة
                            </h4>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">اسم الصيدلية</label>
                                <input type="text" class="search-input" id="pharmacyName" placeholder="صيدلية الصحة">
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">البريد الإلكتروني</label>
                                <input type="email" class="search-input" id="pharmacyEmail" placeholder="pharmacy@example.com">
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">كلمة المرور</label>
                                <div style="position: relative;">
                                    <input type="password" class="search-input" id="pharmacyPassword" placeholder="••••••••" style="padding-left: 50px;">
                                    <button type="button" id="toggleRegisterPassword" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer;">
                                        <i class="far fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">رقم الهاتف</label>
                                <input type="tel" class="search-input" id="pharmacyPhone" placeholder="05xxxxxxxx">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">العنوان</label>
                                <input type="text" class="search-input" id="pharmacyAddress" placeholder="شارع الملك فهد، الرياض">
                            </div>
                            
                            <button class="btn-modern btn-pharmacy-modern" id="registerBtn">
                                <i class="fas fa-check-circle"></i>
                                تسجيل الصيدلية
                            </button>
                            
                            <div style="text-align: center; margin-top: 16px;">
                                <span style="color: var(--text-secondary);">لديك حساب؟</span>
                                <button id="showLogin" style="background: none; border: none; color: var(--pharmacy-color); font-weight: 700; cursor: pointer;">تسجيل دخول</button>
                            </div>
                        </div>
                        
                        <!-- إدارة المخزون -->
                        <div id="inventorySection" style="display: none;">
                            <h4 style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                                <i class="fas fa-boxes" style="color: var(--pharmacy-color);"></i>
                                إدارة المخزون
                            </h4>
                            
                            <div style="background: var(--pharmacy-gradient); padding: 16px; border-radius: var(--radius-lg); color: white; margin-bottom: 20px;">
                                <h5 id="loggedPharmacyName" style="margin-bottom: 4px; font-size: 1.1rem;">صيدلية الصحة</h5>
                                <p id="loggedPharmacyAddress" style="opacity: 0.9; font-size: 0.9rem; display: flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-map-marker-alt"></i> شارع الملك فهد، الرياض
                                </p>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                                <input type="text" class="search-input" id="addMedicineInput" placeholder="اسم الدواء الجديد" style="flex: 1;">
                                <button class="btn-modern btn-primary-modern" id="addMedicineBtn" style="width: auto; min-width: 60px;">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            
                            <div class="pharmacy-grid" id="inventoryList" style="max-height: 350px;">
                                <!-- سيتم إضافة الأدوية هنا -->
                                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 16px;"></i>
                                    <p>جاري تحميل المخزون...</p>
                                </div>
                            </div>
                            
                            <button class="btn-modern btn-outline-modern" id="removeOutOfStockBtn" style="margin-top: 16px;">
                                <i class="fas fa-trash-alt"></i>
                                حذف الأدوية المنتهية
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- حاوية الخريطة -->
        <div class="map-wrapper">
            <div id="map"></div>
            
            <!-- دليل الخريطة العصري -->
            <div class="map-legend" id="mapLegend">
                <h3>
                    <i class="fas fa-map-marked-alt" style="color: var(--primary-color);"></i>
                    دليل الخريطة
                </h3>
                <div class="legend-items">
                    <div class="legend-item">
                        <span class="legend-dot" style="background: var(--user-color);"></span>
                        <span>موقعك</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: var(--primary-color);"></span>
                        <span>صيدليات</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: var(--pharmacy-color);"></span>
                        <span>صيدليتك</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: var(--success-color);"></span>
                        <span>دواء متوفر</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- زر الإجراء السريع للجوال -->
    <button class="mobile-fab" id="mobileFab">
        <i class="fas fa-search"></i>
    </button>

    <!-- نافذة تفاصيل الصيدلية -->
    <div class="modal" id="pharmacyModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; padding: 16px;">
        <div style="background: white; border-radius: var(--radius-xl); max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto; padding: 24px; box-shadow: var(--shadow-xl);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="modalPharmacyName" style="font-size: 1.3rem;">تفاصيل الصيدلية</h2>
                <button class="close-modal" id="closePharmacyModal" style="background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--text-muted);">×</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg-color); border-radius: var(--radius-lg); margin-bottom: 16px;">
                    <i class="fas fa-map-marker-alt" style="color: var(--primary-color); font-size: 1.2rem;"></i>
                    <span id="modalPharmacyAddress">شارع الملك فهد، الرياض</span>
                </div>
                
                <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg-color); border-radius: var(--radius-lg); margin-bottom: 16px;">
                    <i class="fas fa-phone" style="color: var(--primary-color); font-size: 1.2rem;"></i>
                    <span id="modalPharmacyPhone">05xxxxxxxx</span>
                </div>
                
                <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg-color); border-radius: var(--radius-lg); margin-bottom: 16px;">
                    <i class="fas fa-location-arrow" style="color: var(--primary-color); font-size: 1.2rem;"></i>
                    <span id="modalPharmacyDistance">0.8 كم</span>
                </div>
            </div>
            
            <h4 style="margin-bottom: 16px;">الأدوية المتوفرة</h4>
            <div id="modalMedicineList" style="margin-bottom: 24px;"></div>
            
            <button class="btn-modern btn-primary-modern" id="getDirectionsBtn">
                <i class="fas fa-directions"></i>
                احصل على الاتجاهات
            </button>
        </div>
    </div>

    <!-- نافذة عن الخدمة -->
    <div class="modal" id="aboutModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; padding: 16px;">
        <div style="background: white; border-radius: var(--radius-xl); max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; padding: 24px; box-shadow: var(--shadow-xl);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="font-size: 1.3rem;">عن الخدمة</h2>
                <button class="close-modal" id="closeAboutModal" style="background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--text-muted);">×</button>
            </div>
            
            <div style="line-height: 1.8;">
                <p style="margin-bottom: 16px; font-size: 1.1rem; font-weight: 700;">"دواؤك ليس بعيداً.. نحن نربطك بالصيدلية الأقرب"</p>
                
                <h4 style="margin: 20px 0 10px; color: var(--primary-color);">الرؤية العامة</h4>
                <p style="margin-bottom: 16px;">تطبيق منصة ذكية تعمل كحلقة وصل تقنية فورية بين المرضى والصيدليات. تهدف الفكرة إلى حل مشكلة "رحلة البحث الشاقة" عن الأدوية، خاصة الناقصة منها أو أدوية الأمراض المزمنة.</p>
                
                <h4 style="margin: 20px 0 10px; color: var(--primary-color);">الميزات الأساسية</h4>
                <ul style="margin-right: 20px; margin-bottom: 16px;">
                    <li>البحث الذكي باسم الدواء</li>
                    <li>نظام التوفر اللحظي</li>
                    <li>الخريطة التفاعلية</li>
                    <li>الحجز المؤقت للدواء</li>
                    <li>اقتراح بدائل الدواء</li>
                </ul>
                
                <h4 style="margin: 20px 0 10px; color: var(--primary-color);">القيمة المضافة</h4>
                <p>للمريض: توفير الجهد والوقت والمال المستهلك في التنقل بين الصيدليات.</p>
                <p>للصيدلي: زيادة المبيعات والوصول لعملاء جدد.</p>
            </div>
        </div>
    </div>

    <!-- إشعار عصري -->
    <div class="modern-toast" id="modernToast">
        <div class="toast-icon" id="toastIcon" style="background: var(--primary-light); color: var(--primary-color);">
            <i class="fas fa-info-circle"></i>
        </div>
        <div class="toast-content">
            <div class="toast-title" id="toastTitle">إشعار</div>
            <div class="toast-message" id="toastMessage">هذه رسالة إشعار</div>
        </div>
    </div>

    <!-- شاشة التحميل -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <p id="loadingText" style="font-size: 1.1rem; color: var(--text-primary);">جاري التحميل...</p>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ==============================================
        // إعدادات Firebase - نفس التكوين السابق
        // ==============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBNsJQZgS1J2d0oFhHAA1MR3nmmvCtJ-ME",
            authDomain: "pharmaconnect-e89fa.firebaseapp.com",
            databaseURL: "https://pharmaconnect-e89fa-default-rtdb.firebaseio.com",
            projectId: "pharmaconnect-e89fa",
            storageBucket: "pharmaconnect-e89fa.firebasestorage.app",
            messagingSenderId: "100345757491",
            appId: "1:100345757491:web:c7f3c1d93835f0dcabc846",
            measurementId: "G-05J05FX4TH"
        };

        // تهيئة Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // تفعيل التخزين المؤقت
        db.enablePersistence().catch(err => console.log('Persistence error:', err));

        // ==============================================
        // حالة التطبيق
        // ==============================================
        const state = {
            userLocation: null,
            userType: 'patient',
            currentUser: null,
            currentPharmacy: null,
            currentPharmacyId: null,
            pharmacies: [],
            map: null,
            markers: [],
            userMarker: null,
            radiusCircle: null,
            searchRadius: 5,
            selectedMedicine: '',
            isSidebarOpen: false,
            isMobile: window.innerWidth <= 992,
            currentLanguage: 'ar'
        };

        // ==============================================
        // تهيئة التطبيق
        // ==============================================
        document.addEventListener('DOMContentLoaded', async function() {
            // تهيئة عناصر الواجهة
            initializeUI();
            
            // التحقق من حجم الشاشة
            checkMobileView();
            
            // تهيئة المصادقة
            initializeAuth();
            
            // تهيئة الخريطة
            await initializeMap();
            
            // تحديد الموقع
            await initializeLocation();
            
            // تحميل الصيدليات
            await loadPharmacies();
            
            // تحديث واجهة المستخدم
            renderRecentPharmacies();
        });

        // ==============================================
        // تهيئة واجهة المستخدم
        // ==============================================
        function initializeUI() {
            // أزرار التبديل
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    switchUserType(type);
                });
            });
            
            // زر القائمة للجوال
            const menuBtn = document.getElementById('mobileMenuBtn');
            const sidebar = document.getElementById('pharmaSidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            
            if (menuBtn) {
                menuBtn.addEventListener('click', toggleSidebar);
            }
            
            if (backdrop) {
                backdrop.addEventListener('click', closeSidebar);
            }
            
            // مؤشر السحب للجوال
            const dragHandle = document.getElementById('dragHandle');
            if (dragHandle && state.isMobile) {
                let startY = 0;
                let currentY = 0;
                
                dragHandle.addEventListener('touchstart', (e) => {
                    startY = e.touches[0].clientY;
                });
                
                dragHandle.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    currentY = e.touches[0].clientY;
                    const deltaY = currentY - startY;
                    
                    if (deltaY > 0 && state.isSidebarOpen) {
                        // السحب للأسفل
                        const translateY = Math.min(deltaY, 300);
                        sidebar.style.transform = `translateY(${translateY}px)`;
                    }
                });
                
                dragHandle.addEventListener('touchend', () => {
                    const transform = sidebar.style.transform;
                    if (transform) {
                        const translateY = parseInt(transform.match(/\d+/)?.[0] || 0);
                        if (translateY > 100) {
                            closeSidebar();
                        } else {
                            sidebar.style.transform = '';
                            if (state.isSidebarOpen) {
                                sidebar.classList.add('open');
                            }
                        }
                    }
                });
            }
            
            // زر الإجراء السريع
            const fab = document.getElementById('mobileFab');
            if (fab) {
                fab.addEventListener('click', function() {
                    if (state.userType === 'patient') {
                        const medicine = document.getElementById('medicineSearch').value;
                        if (medicine) {
                            searchMedicine(medicine);
                        } else {
                            showToast('الرجاء إدخال اسم الدواء', 'info');
                        }
                    } else {
                        if (!state.currentUser) {
                            switchUserType('pharmacy');
                            if (!state.isSidebarOpen) toggleSidebar();
                        }
                    }
                });
            }
            
            // منزلق النطاق
            const slider = document.getElementById('searchRadius');
            const radiusValue = document.getElementById('radiusValue');
            
            if (slider) {
                slider.addEventListener('input', function() {
                    radiusValue.textContent = this.value;
                    state.searchRadius = parseInt(this.value);
                    
                    // تحديث لون التدرج
                    const percentage = (this.value - this.min) / (this.max - this.min) * 100;
                    this.style.background = `linear-gradient(to right, var(--primary-color) 0%, var(--primary-color) ${percentage}%, var(--border-color) ${percentage}%)`;
                    
                    updateRadiusCircle();
                });
            }
            
            // حقل البحث
            const searchInput = document.getElementById('medicineSearch');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(function() {
                    showSuggestions(this.value);
                }, 300));
            }
            
            // زر البحث
            const searchBtn = document.getElementById('searchBtn');
            if (searchBtn) {
                searchBtn.addEventListener('click', function() {
                    const medicine = document.getElementById('medicineSearch').value;
                    if (medicine) {
                        searchMedicine(medicine);
                    } else {
                        showToast('الرجاء إدخال اسم الدواء', 'error');
                    }
                });
            }
            
            // عينات الأدوية
            document.querySelectorAll('.sample-med').forEach(item => {
                item.addEventListener('click', function() {
                    const med = this.textContent;
                    document.getElementById('medicineSearch').value = med;
                    searchMedicine(med);
                });
            });
            
            // نماذج المصادقة
            document.getElementById('showRegister')?.addEventListener('click', function() {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('registerForm').style.display = 'block';
            });
            
            document.getElementById('showLogin')?.addEventListener('click', function() {
                document.getElementById('registerForm').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';
            });
            
            // إظهار/إخفاء كلمة المرور
            document.getElementById('toggleLoginPassword')?.addEventListener('click', function() {
                const input = document.getElementById('loginPassword');
                const icon = this.querySelector('i');
                togglePassword(input, icon);
            });
            
            document.getElementById('toggleRegisterPassword')?.addEventListener('click', function() {
                const input = document.getElementById('pharmacyPassword');
                const icon = this.querySelector('i');
                togglePassword(input, icon);
            });
            
            // أزرار المصادقة
            document.getElementById('loginBtn')?.addEventListener('click', handleLogin);
            document.getElementById('registerBtn')?.addEventListener('click', handleRegister);
            document.getElementById('logoutBtn')?.addEventListener('click', handleLogout);
            
            // إدارة المخزون
            document.getElementById('addMedicineBtn')?.addEventListener('click', addMedicine);
            document.getElementById('removeOutOfStockBtn')?.addEventListener('click', removeOutOfStock);
            
            // النوافذ المنبثقة
            document.getElementById('aboutBtn')?.addEventListener('click', function() {
                document.getElementById('aboutModal').style.display = 'flex';
            });
            
            document.getElementById('closeAboutModal')?.addEventListener('click', function() {
                document.getElementById('aboutModal').style.display = 'none';
            });
            
            document.getElementById('closePharmacyModal')?.addEventListener('click', closePharmacyModal);
            
            // دليل الخريطة
            const legend = document.getElementById('mapLegend');
            if (legend) {
                legend.addEventListener('click', function() {
                    this.classList.toggle('collapsed');
                });
            }
            
            // زر اللغة
            document.getElementById('langToggleBtn')?.addEventListener('click', toggleLanguage);
            
            // حدث التمرير للهيدر
            window.addEventListener('scroll', function() {
                const header = document.getElementById('appHeader');
                if (window.scrollY > 10) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
            });
            
            // حدث تغيير حجم الشاشة
            window.addEventListener('resize', debounce(function() {
                checkMobileView();
                if (state.map) {
                    state.map.invalidateSize();
                }
            }, 250));
        }

        // ==============================================
        // التحقق من حجم الشاشة
        // ==============================================
        function checkMobileView() {
            state.isMobile = window.innerWidth <= 992;
            
            const sidebar = document.getElementById('pharmaSidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            const menuBtn = document.getElementById('mobileMenuBtn');
            
            if (state.isMobile) {
                // وضع الجوال
                if (sidebar) {
                    sidebar.classList.remove('open');
                    state.isSidebarOpen = false;
                }
                if (backdrop) backdrop.style.display = 'none';
                if (menuBtn) menuBtn.style.display = 'flex';
            } else {
                // وضع سطح المكتب
                if (sidebar) {
                    sidebar.classList.add('open');
                    state.isSidebarOpen = true;
                    sidebar.style.transform = '';
                }
                if (backdrop) backdrop.style.display = 'none';
                if (menuBtn) menuBtn.style.display = 'none';
            }
        }

        // ==============================================
        // تبديل الشريط الجانبي
        // ==============================================
        function toggleSidebar() {
            const sidebar = document.getElementById('pharmaSidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            
            if (state.isSidebarOpen) {
                closeSidebar();
            } else {
                openSidebar();
            }
        }
        
        function openSidebar() {
            const sidebar = document.getElementById('pharmaSidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            
            sidebar.classList.add('open');
            sidebar.style.transform = '';
            state.isSidebarOpen = true;
            
            if (state.isMobile) {
                backdrop.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            document.getElementById('mobileMenuBtn').innerHTML = '<i class="fas fa-times"></i>';
        }
        
        function closeSidebar() {
            const sidebar = document.getElementById('pharmaSidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            
            sidebar.classList.remove('open');
            state.isSidebarOpen = false;
            
            if (state.isMobile) {
                backdrop.style.display = 'none';
                document.body.style.overflow = '';
                sidebar.style.transform = '';
            }
            
            document.getElementById('mobileMenuBtn').innerHTML = '<i class="fas fa-bars"></i>';
        }

        // ==============================================
        // تبديل نوع المستخدم
        // ==============================================
        function switchUserType(type) {
            state.userType = type;
            
            // تحديث التبويبات
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.tab-btn[data-type="${type}"]`).classList.add('active');
            
            // تحديث اللوحات
            document.querySelectorAll('.panel').forEach(panel => {
                panel.style.display = 'none';
            });
            
            if (type === 'patient') {
                document.getElementById('patientPanel').style.display = 'block';
                document.getElementById('patientTabBtn').classList.add('active');
                showAllPharmaciesOnMap();
            } else {
                document.getElementById('pharmacyPanel').style.display = 'block';
                document.getElementById('pharmacyTabBtn').classList.add('active');
                
                if (state.currentPharmacy) {
                    document.getElementById('inventorySection').style.display = 'block';
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('registerForm').style.display = 'none';
                    highlightCurrentPharmacy();
                } else {
                    document.getElementById('inventorySection').style.display = 'none';
                    document.getElementById('loginForm').style.display = 'block';
                }
            }
            
            // فتح الشريط الجانبي في الجوال
            if (state.isMobile && !state.isSidebarOpen) {
                openSidebar();
            }
            
            // تحديث الخريطة
            setTimeout(() => {
                if (state.map) state.map.invalidateSize();
            }, 300);
        }

        // ==============================================
        // تهيئة المصادقة
        // ==============================================
        function initializeAuth() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    state.currentUser = user;
                    
                    // تحديث واجهة المستخدم
                    document.getElementById('userChip').style.display = 'flex';
                    document.getElementById('userName').textContent = user.displayName || user.email.split('@')[0];
                    document.getElementById('userAvatar').textContent = (user.displayName || user.email).charAt(0).toUpperCase();
                    document.getElementById('logoutBtn').style.display = 'flex';
                    
                    // البحث عن حساب الصيدلية
                    try {
                        const snapshot = await db.collection('pharmacies')
                            .where('ownerId', '==', user.uid)
                            .limit(1)
                            .get();
                        
                        if (!snapshot.empty) {
                            const doc = snapshot.docs[0];
                            state.currentPharmacy = { id: doc.id, ...doc.data() };
                            state.currentPharmacyId = doc.id;
                            
                            if (state.userType === 'pharmacy') {
                                showInventorySection();
                                loadInventory();
                                setupInventoryListener();
                            }
                        }
                    } catch (error) {
                        console.error('Error loading pharmacy:', error);
                    }
                } else {
                    // تسجيل الخروج
                    state.currentUser = null;
                    state.currentPharmacy = null;
                    state.currentPharmacyId = null;
                    
                    document.getElementById('userChip').style.display = 'none';
                    document.getElementById('logoutBtn').style.display = 'none';
                    
                    if (state.userType === 'pharmacy') {
                        document.getElementById('inventorySection').style.display = 'none';
                        document.getElementById('loginForm').style.display = 'block';
                        document.getElementById('registerForm').style.display = 'none';
                    }
                    
                    if (window.inventoryListener) {
                        window.inventoryListener();
                        window.inventoryListener = null;
                    }
                }
            });
        }

        // ==============================================
        // معالجات المصادقة
        // ==============================================
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showToast('الرجاء إدخال البريد الإلكتروني وكلمة المرور', 'error');
                return;
            }
            
            try {
                showLoading('جاري تسجيل الدخول...');
                await auth.signInWithEmailAndPassword(email, password);
                hideLoading();
                showToast('تم تسجيل الدخول بنجاح', 'success');
                closeSidebar();
            } catch (error) {
                hideLoading();
                let message = 'فشل تسجيل الدخول';
                if (error.code === 'auth/user-not-found') message = 'البريد الإلكتروني غير مسجل';
                if (error.code === 'auth/wrong-password') message = 'كلمة المرور غير صحيحة';
                if (error.code === 'auth/invalid-email') message = 'البريد الإلكتروني غير صالح';
                showToast(message, 'error');
            }
        }

        async function handleRegister() {
            const name = document.getElementById('pharmacyName').value;
            const email = document.getElementById('pharmacyEmail').value;
            const password = document.getElementById('pharmacyPassword').value;
            const phone = document.getElementById('pharmacyPhone').value;
            const address = document.getElementById('pharmacyAddress').value;
            
            if (!name || !email || !password || !phone || !address) {
                showToast('الرجاء ملء جميع الحقول', 'error');
                return;
            }
            
            if (password.length < 6) {
                showToast('كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'error');
                return;
            }
            
            try {
                showLoading('جاري تسجيل الصيدلية...');
                
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                await user.updateProfile({ displayName: name });
                
                const pharmacyData = {
                    name,
                    email,
                    phone,
                    address,
                    location: state.userLocation || { lat: 24.7136, lng: 46.6753 },
                    inventory: [],
                    ownerId: user.uid,
                    registeredAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                const docRef = await db.collection('pharmacies').add(pharmacyData);
                pharmacyData.id = docRef.id;
                
                state.currentPharmacy = pharmacyData;
                state.currentPharmacyId = docRef.id;
                state.pharmacies.push(pharmacyData);
                
                hideLoading();
                showToast(`مرحباً بك في ${name}! تم التسجيل بنجاح`, 'success');
                
                switchUserType('pharmacy');
                showInventorySection();
                loadInventory();
                
            } catch (error) {
                hideLoading();
                let message = 'فشل التسجيل';
                if (error.code === 'auth/email-already-in-use') message = 'البريد الإلكتروني مستخدم بالفعل';
                if (error.code === 'auth/weak-password') message = 'كلمة المرور ضعيفة';
                showToast(message, 'error');
            }
        }

        async function handleLogout() {
            try {
                showLoading('جاري تسجيل الخروج...');
                await auth.signOut();
                hideLoading();
                showToast('تم تسجيل الخروج بنجاح', 'success');
                
                if (state.userType === 'pharmacy') {
                    switchUserType('patient');
                }
            } catch (error) {
                hideLoading();
                showToast('فشل تسجيل الخروج', 'error');
            }
        }

        // ==============================================
        // إدارة المخزون
        // ==============================================
        function showInventorySection() {
            document.getElementById('inventorySection').style.display = 'block';
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            
            if (state.currentPharmacy) {
                document.getElementById('loggedPharmacyName').textContent = state.currentPharmacy.name;
                document.getElementById('loggedPharmacyAddress').textContent = state.currentPharmacy.address;
                highlightCurrentPharmacy();
            }
        }

        async function loadInventory() {
            if (!state.currentPharmacyId) return;
            
            try {
                const doc = await db.collection('pharmacies').doc(state.currentPharmacyId).get();
                if (doc.exists) {
                    const inventory = doc.data().inventory || [];
                    state.currentPharmacy.inventory = inventory;
                    renderInventory(inventory);
                }
            } catch (error) {
                console.error('Error loading inventory:', error);
                showToast('تعذر تحميل المخزون', 'error');
            }
        }

        function setupInventoryListener() {
            if (!state.currentPharmacyId) return;
            
            if (window.inventoryListener) {
                window.inventoryListener();
            }
            
            window.inventoryListener = db.collection('pharmacies')
                .doc(state.currentPharmacyId)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const inventory = doc.data().inventory || [];
                        state.currentPharmacy.inventory = inventory;
                        renderInventory(inventory);
                    }
                }, (error) => {
                    console.error('Inventory listener error:', error);
                });
        }

        function renderInventory(inventory) {
            const container = document.getElementById('inventoryList');
            
            if (!inventory || inventory.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <i class="fas fa-box-open" style="font-size: 2.5rem; margin-bottom: 16px;"></i>
                        <p>لا توجد أدوية في المخزون</p>
                        <p style="font-size: 0.9rem; margin-top: 8px;">أضف دواء جديد من الأعلى</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            inventory.forEach((item, index) => {
                if (!item || !item.name) return;
                
                const stockClass = item.stock === 'high' ? 'stock-high' : 
                                 item.stock === 'medium' ? 'stock-medium' : 
                                 item.stock === 'low' ? 'stock-low' : 'stock-out';
                
                const stockText = item.stock === 'high' ? 'مخزون عالي' : 
                                item.stock === 'medium' ? 'مخزون متوسط' : 
                                item.stock === 'low' ? 'مخزون منخفض' : 'نفذ من المخزون';
                
                html += `
                    <div class="pharmacy-card" style="margin-bottom: 0; padding: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0 0 4px; font-size: 1rem;">${item.name}</h4>
                                <span style="color: var(--text-muted); font-size: 0.85rem;">${item.price || 'غير محدد'}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <select data-index="${index}" class="stock-select" style="padding: 8px; border-radius: var(--radius-md); border: 1px solid var(--border-color); background: white; font-family: var(--font-arabic);">
                                    <option value="high" ${item.stock === 'high' ? 'selected' : ''}>عالي</option>
                                    <option value="medium" ${item.stock === 'medium' ? 'selected' : ''}>متوسط</option>
                                    <option value="low" ${item.stock === 'low' ? 'selected' : ''}>منخفض</option>
                                    <option value="out" ${item.stock === 'out' ? 'selected' : ''}>نفذ</option>
                                </select>
                                <button class="remove-btn" data-index="${index}" style="background: none; border: none; color: var(--danger-color); cursor: pointer; width: 36px; height: 36px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div style="margin-top: 8px;">
                            <span class="stock-chip ${stockClass}">${stockText}</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // إضافة مستمعي الأحداث
            container.querySelectorAll('.stock-select').forEach(select => {
                select.addEventListener('change', function() {
                    const index = this.getAttribute('data-index');
                    updateStock(index, this.value);
                });
            });
            
            container.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    removeMedicineItem(index);
                });
            });
        }

        async function addMedicine() {
            const input = document.getElementById('addMedicineInput');
            const name = input.value.trim();
            
            if (!name) {
                showToast('الرجاء إدخال اسم الدواء', 'error');
                return;
            }
            
            if (!state.currentPharmacyId) {
                showToast('لم يتم العثور على الصيدلية', 'error');
                return;
            }
            
            try {
                showLoading('جاري إضافة الدواء...');
                
                const pharmacyRef = db.collection('pharmacies').doc(state.currentPharmacyId);
                const doc = await pharmacyRef.get();
                
                const inventory = doc.data().inventory || [];
                
                // التحقق من وجود الدواء
                if (inventory.some(item => item.name.toLowerCase() === name.toLowerCase())) {
                    hideLoading();
                    showToast('الدواء موجود بالفعل', 'warning');
                    return;
                }
                
                const newMedicine = {
                    name: name,
                    stock: 'high',
                    price: (Math.random() * 40 + 10).toFixed(2) + ' ر.س',
                    addedAt: new Date().toISOString()
                };
                
                inventory.push(newMedicine);
                
                await pharmacyRef.update({
                    inventory: inventory,
                    updatedAt: new Date().toISOString()
                });
                
                input.value = '';
                hideLoading();
                showToast(`تم إضافة ${name}`, 'success');
                
            } catch (error) {
                hideLoading();
                console.error('Error adding medicine:', error);
                showToast('فشل إضافة الدواء', 'error');
            }
        }

        async function updateStock(index, status) {
            if (!state.currentPharmacyId) return;
            
            try {
                const pharmacyRef = db.collection('pharmacies').doc(state.currentPharmacyId);
                const doc = await pharmacyRef.get();
                
                const inventory = doc.data().inventory || [];
                if (inventory[index]) {
                    inventory[index].stock = status;
                    inventory[index].lastUpdated = new Date().toISOString();
                    
                    await pharmacyRef.update({
                        inventory: inventory,
                        updatedAt: new Date().toISOString()
                    });
                    
                    showToast('تم تحديث حالة المخزون', 'success');
                }
            } catch (error) {
                console.error('Error updating stock:', error);
                showToast('فشل تحديث المخزون', 'error');
            }
        }

        async function removeMedicineItem(index) {
            if (!state.currentPharmacyId) return;
            
            try {
                const pharmacyRef = db.collection('pharmacies').doc(state.currentPharmacyId);
                const doc = await pharmacyRef.get();
                
                const inventory = doc.data().inventory || [];
                if (inventory[index]) {
                    const name = inventory[index].name;
                    
                    if (confirm(`هل أنت متأكد من حذف "${name}"؟`)) {
                        inventory.splice(index, 1);
                        
                        await pharmacyRef.update({
                            inventory: inventory,
                            updatedAt: new Date().toISOString()
                        });
                        
                        showToast(`تم حذف ${name}`, 'success');
                    }
                }
            } catch (error) {
                console.error('Error removing medicine:', error);
                showToast('فشل حذف الدواء', 'error');
            }
        }

        async function removeOutOfStock() {
            if (!state.currentPharmacyId) return;
            
            try {
                const pharmacyRef = db.collection('pharmacies').doc(state.currentPharmacyId);
                const doc = await pharmacyRef.get();
                
                const inventory = doc.data().inventory || [];
                const outOfStock = inventory.filter(item => item.stock === 'out');
                
                if (outOfStock.length === 0) {
                    showToast('لا توجد أدوية منتهية', 'info');
                    return;
                }
                
                if (confirm(`هل أنت متأكد من حذف ${outOfStock.length} دواء منتهي؟`)) {
                    const newInventory = inventory.filter(item => item.stock !== 'out');
                    
                    await pharmacyRef.update({
                        inventory: newInventory,
                        updatedAt: new Date().toISOString()
                    });
                    
                    showToast(`تم حذف ${outOfStock.length} دواء`, 'success');
                }
            } catch (error) {
                console.error('Error removing out of stock:', error);
                showToast('فشل حذف الأدوية', 'error');
            }
        }

        // ==============================================
        // تهيئة الخريطة
        // ==============================================
        async function initializeMap() {
            state.map = L.map('map', {
                zoomControl: false,
                fadeAnimation: true,
                markerZoomAnimation: true
            }).setView([24.7136, 46.6753], 12);
            
            L.control.zoom({
                position: 'bottomright'
            }).addTo(state.map);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'OpenStreetMap',
                maxZoom: 19,
                detectRetina: true
            }).addTo(state.map);
            
            // إصلاح حجم الخريطة
            setTimeout(() => {
                state.map.invalidateSize();
            }, 500);
            
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    state.map.invalidateSize();
                }, 300);
            });
        }

        // ==============================================
        // تحديد الموقع
        // ==============================================
        async function initializeLocation() {
            if (!navigator.geolocation) {
                setDefaultLocation();
                return;
            }
            
            try {
                showLoading('جاري تحديد موقعك...');
                
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    });
                });
                
                state.userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                state.map.setView([state.userLocation.lat, state.userLocation.lng], 14);
                
                addUserMarker();
                updateRadiusCircle();
                
                document.getElementById('locationText').textContent = 'تم تحديد موقعك بنجاح';
                
                hideLoading();
                showToast('تم تحديد موقعك', 'success');
                
            } catch (error) {
                console.error('Location error:', error);
                setDefaultLocation();
                hideLoading();
            }
        }

        function setDefaultLocation() {
            state.userLocation = { lat: 24.7136, lng: 46.6753 };
            state.map.setView([state.userLocation.lat, state.userLocation.lng], 12);
            
            addUserMarker();
            updateRadiusCircle();
            
            document.getElementById('locationText').textContent = 'الرياض (موقع افتراضي)';
        }

        function addUserMarker() {
            if (state.userMarker) {
                state.map.removeLayer(state.userMarker);
            }
            
            state.userMarker = L.marker([state.userLocation.lat, state.userLocation.lng], {
                icon: L.divIcon({
                    html: `<div style="background: var(--user-color); width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></div>`,
                    className: 'user-marker',
                    iconSize: [26, 26]
                })
            }).addTo(state.map).bindPopup('موقعك');
        }

        function updateRadiusCircle() {
            if (state.radiusCircle) {
                state.map.removeLayer(state.radiusCircle);
            }
            
            if (state.userLocation) {
                state.radiusCircle = L.circle([state.userLocation.lat, state.userLocation.lng], {
                    color: 'var(--user-color)',
                    fillColor: 'var(--user-color)',
                    fillOpacity: 0.1,
                    radius: state.searchRadius * 1000,
                    weight: 2,
                    opacity: 0.5
                }).addTo(state.map);
            }
        }

        // ==============================================
        // تحميل الصيدليات
        // ==============================================
        async function loadPharmacies() {
            try {
                showLoading('جاري تحميل الصيدليات...');
                
                const snapshot = await db.collection('pharmacies').limit(50).get();
                state.pharmacies = [];
                
                snapshot.forEach(doc => {
                    state.pharmacies.push({ id: doc.id, ...doc.data() });
                });
                
                hideLoading();
                
                if (state.pharmacies.length === 0) {
                    loadMockData();
                } else {
                    showAllPharmaciesOnMap();
                    renderRecentPharmacies();
                }
                
            } catch (error) {
                console.error('Error loading pharmacies:', error);
                hideLoading();
                loadMockData();
            }
        }

        function loadMockData() {
            state.pharmacies = [
                {
                    id: 'ph1',
                    name: 'صيدلية الصحة',
                    address: 'شارع الملك فهد، الرياض',
                    phone: '0555555555',
                    location: { lat: 24.7136, lng: 46.6753 },
                    registeredAt: new Date().toISOString(),
                    inventory: [
                        { name: 'أموكسيسيلين', stock: 'high', price: '15.99 ر.س' },
                        { name: 'ميتفورمين', stock: 'medium', price: '12.50 ر.س' },
                        { name: 'فينتولين', stock: 'low', price: '28.75 ر.س' }
                    ]
                },
                {
                    id: 'ph2',
                    name: 'صيدلية النخبة',
                    address: 'حي النخيل، الرياض',
                    phone: '0566666666',
                    location: { lat: 24.8036, lng: 46.6438 },
                    registeredAt: new Date().toISOString(),
                    inventory: [
                        { name: 'أموكسيسيلين', stock: 'low', price: '16.50 ر.س' },
                        { name: 'أيبوبروفين', stock: 'high', price: '8.99 ر.س' }
                    ]
                },
                {
                    id: 'ph3',
                    name: 'صيدلية السلام',
                    address: 'حي الملقا، الرياض',
                    phone: '0577777777',
                    location: { lat: 24.7580, lng: 46.6855 },
                    registeredAt: new Date().toISOString(),
                    inventory: [
                        { name: 'فينتولين', stock: 'high', price: '30.25 ر.س' },
                        { name: 'أوميبرازول', stock: 'medium', price: '18.50 ر.س' }
                    ]
                }
            ];
            
            showAllPharmaciesOnMap();
            renderRecentPharmacies();
        }

        // ==============================================
        // إدارة الخريطة والعلامات
        // ==============================================
        function clearMarkers() {
            state.markers.forEach(marker => {
                if (marker && state.map.hasLayer(marker)) {
                    state.map.removeLayer(marker);
                }
            });
            state.markers = [];
        }

        function showAllPharmaciesOnMap() {
            clearMarkers();
            
            if (!state.userMarker && state.userLocation) {
                addUserMarker();
            }
            
            state.pharmacies.forEach(pharmacy => {
                if (pharmacy.location) {
                    addPharmacyMarker(pharmacy);
                }
            });
            
            // تكبير الخريطة لعرض جميع العناصر
            if (state.userLocation && state.pharmacies.length > 0) {
                const bounds = L.latLngBounds([
                    [state.userLocation.lat, state.userLocation.lng],
                    ...state.pharmacies.map(p => [p.location.lat, p.location.lng])
                ]);
                state.map.fitBounds(bounds, { padding: [30, 30], maxZoom: 14 });
            }
        }

        function addPharmacyMarker(pharmacy) {
            if (!pharmacy.location) return;
            
            const isCurrentPharmacy = state.currentPharmacy && state.currentPharmacy.id === pharmacy.id;
            
            const marker = L.marker([pharmacy.location.lat, pharmacy.location.lng], {
                icon: L.divIcon({
                    html: `<div style="background: ${isCurrentPharmacy ? 'var(--pharmacy-color)' : 'var(--primary-color)'}; width: 18px; height: 18px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></div>`,
                    className: 'pharmacy-marker',
                    iconSize: [24, 24]
                })
            })
            .addTo(state.map)
            .bindPopup(`<b>${pharmacy.name}</b><br>${pharmacy.address}`)
            .on('click', function() {
                showPharmacyDetails(pharmacy.id);
            });
            
            state.markers.push(marker);
        }

        function highlightCurrentPharmacy() {
            if (!state.currentPharmacy || !state.currentPharmacy.location) return;
            
            clearMarkers();
            
            if (state.userLocation) {
                addUserMarker();
                updateRadiusCircle();
            }
            
            const marker = L.marker([state.currentPharmacy.location.lat, state.currentPharmacy.location.lng], {
                icon: L.divIcon({
                    html: `<div style="background: var(--pharmacy-color); width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 12px rgba(114,9,183,0.4);"></div>`,
                    className: 'current-pharmacy-marker',
                    iconSize: [30, 30]
                })
            })
            .addTo(state.map)
            .bindPopup(`<b>صيدليتك: ${state.currentPharmacy.name}</b>`)
            .openPopup();
            
            state.markers.push(marker);
            
            if (state.userLocation) {
                const bounds = L.latLngBounds([
                    [state.userLocation.lat, state.userLocation.lng],
                    [state.currentPharmacy.location.lat, state.currentPharmacy.location.lng]
                ]);
                state.map.fitBounds(bounds, { padding: [50, 50], maxZoom: 15 });
            }
        }

        // ==============================================
        // حساب المسافة
        // ==============================================
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ==============================================
        // البحث عن الدواء
        // ==============================================
        function searchMedicine(medicineName) {
            if (!medicineName) return;
            
            state.selectedMedicine = medicineName;
            
            const results = [];
            const searchTerm = medicineName.toLowerCase();
            
            state.pharmacies.forEach(pharmacy => {
                if (!pharmacy.inventory || !pharmacy.location) return;
                
                const medicine = pharmacy.inventory.find(item => 
                    item && item.name && item.name.toLowerCase().includes(searchTerm)
                );
                
                if (!medicine) return;
                
                if (state.userLocation) {
                    const distance = calculateDistance(
                        state.userLocation.lat, state.userLocation.lng,
                        pharmacy.location.lat, pharmacy.location.lng
                    );
                    
                    if (distance <= state.searchRadius) {
                        pharmacy.distance = distance.toFixed(1);
                        results.push({ ...pharmacy, distance, medicine });
                    }
                } else {
                    pharmacy.distance = 'غير معروف';
                    results.push({ ...pharmacy, medicine });
                }
            });
            
            results.sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance));
            
            displaySearchResults(results, medicineName);
            updateMapWithResults(results, medicineName);
            
            if (results.length === 0) {
                showToast(`لم يتم العثور على "${medicineName}" ضمن ${state.searchRadius} كم`, 'info');
            } else {
                showToast(`تم العثور على ${results.length} صيدلية`, 'success');
                
                if (state.isMobile && state.isSidebarOpen) {
                    setTimeout(() => {
                        const resultsElement = document.getElementById('patientResults');
                        if (resultsElement) {
                            resultsElement.scrollIntoView({ behavior: 'smooth' });
                        }
                    }, 300);
                }
            }
        }

        function displaySearchResults(results, medicineName) {
            const container = document.getElementById('pharmacyResults');
            const resultsContainer = document.getElementById('patientResults');
            const countElement = document.getElementById('resultCount');
            
            if (results.length === 0) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            let html = '';
            results.forEach(pharmacy => {
                const medicine = pharmacy.medicine;
                
                const stockClass = medicine.stock === 'high' ? 'stock-high' : 
                                 medicine.stock === 'medium' ? 'stock-medium' : 
                                 medicine.stock === 'low' ? 'stock-low' : 'stock-out';
                
                const stockText = medicine.stock === 'high' ? 'مخزون عالي' : 
                                medicine.stock === 'medium' ? 'مخزون متوسط' : 
                                medicine.stock === 'low' ? 'مخزون منخفض' : 'نفذ من المخزون';
                
                html += `
                    <div class="pharmacy-card" data-id="${pharmacy.id}">
                        <div class="pharmacy-name">
                            <h4>${pharmacy.name}</h4>
                            <span class="pharmacy-distance">${pharmacy.distance} كم</span>
                        </div>
                        <div class="pharmacy-address">
                            <i class="fas fa-map-marker-alt"></i>
                            ${pharmacy.address}
                        </div>
                        <div class="medicine-stock">
                            <span style="font-weight: 600;">${medicine.name}</span>
                            <span class="stock-chip ${stockClass}">${stockText} • ${medicine.price || ''}</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            resultsContainer.style.display = 'block';
            countElement.textContent = `${results.length} صيدلية`;
            
            // إضافة مستمعي الأحداث
            container.querySelectorAll('.pharmacy-card').forEach(card => {
                card.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    showPharmacyDetails(id);
                    
                    // إزالة التحديد السابق
                    container.querySelectorAll('.pharmacy-card').forEach(c => {
                        c.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
        }

        function updateMapWithResults(results, medicineName) {
            clearMarkers();
            
            if (state.userLocation) {
                addUserMarker();
                updateRadiusCircle();
            }
            
            results.forEach(pharmacy => {
                const medicine = pharmacy.medicine;
                
                let color = 'var(--success-color)';
                if (medicine.stock === 'medium') color = 'var(--warning-color)';
                if (medicine.stock === 'low') color = '#f97316';
                if (medicine.stock === 'out') color = 'var(--danger-color)';
                
                const marker = L.marker([pharmacy.location.lat, pharmacy.location.lng], {
                    icon: L.divIcon({
                        html: `<div style="background: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></div>`,
                        className: 'result-marker',
                        iconSize: [26, 26]
                    })
                })
                .addTo(state.map)
                .bindPopup(`<b>${pharmacy.name}</b><br>${medicineName}: ${medicine.stock}<br>${pharmacy.distance} كم`)
                .on('click', function() {
                    showPharmacyDetails(pharmacy.id);
                });
                
                state.markers.push(marker);
            });
            
            if (results.length > 0) {
                const bounds = L.latLngBounds(results.map(p => [p.location.lat, p.location.lng]));
                if (state.userLocation) {
                    bounds.extend([state.userLocation.lat, state.userLocation.lng]);
                }
                state.map.fitBounds(bounds, { padding: [40, 40], maxZoom: 15 });
            }
        }

        // ==============================================
        // عرض تفاصيل الصيدلية
        // ==============================================
        function showPharmacyDetails(pharmacyId) {
            const pharmacy = state.pharmacies.find(p => p.id === pharmacyId);
            if (!pharmacy) return;
            
            // حساب المسافة
            if (state.userLocation && pharmacy.location) {
                pharmacy.distance = calculateDistance(
                    state.userLocation.lat, state.userLocation.lng,
                    pharmacy.location.lat, pharmacy.location.lng
                ).toFixed(1);
            }
            
            document.getElementById('modalPharmacyName').textContent = pharmacy.name;
            document.getElementById('modalPharmacyAddress').textContent = pharmacy.address;
            document.getElementById('modalPharmacyPhone').textContent = pharmacy.phone || 'غير متوفر';
            document.getElementById('modalPharmacyDistance').textContent = pharmacy.distance ? `${pharmacy.distance} كم` : 'غير معروف';
            
            // قائمة الأدوية
            const medicineList = document.getElementById('modalMedicineList');
            
            if (pharmacy.inventory && pharmacy.inventory.length > 0) {
                let html = '';
                pharmacy.inventory.forEach(item => {
                    if (!item || !item.name) return;
                    
                    const stockClass = item.stock === 'high' ? 'stock-high' : 
                                     item.stock === 'medium' ? 'stock-medium' : 
                                     item.stock === 'low' ? 'stock-low' : 'stock-out';
                    
                    const stockText = item.stock === 'high' ? 'مخزون عالي' : 
                                    item.stock === 'medium' ? 'مخزون متوسط' : 
                                    item.stock === 'low' ? 'مخزون منخفض' : 'نفذ من المخزون';
                    
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border-color);">
                            <span style="font-weight: 500;">${item.name}</span>
                            <span class="stock-chip ${stockClass}">${stockText} • ${item.price || ''}</span>
                        </div>
                    `;
                });
                medicineList.innerHTML = html;
            } else {
                medicineList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-muted);">لا توجد أدوية متوفرة</p>';
            }
            
            // زر الاتجاهات
            document.getElementById('getDirectionsBtn').onclick = function() {
                if (pharmacy.location) {
                    const url = `https://www.google.com/maps/dir/?api=1&destination=${pharmacy.location.lat},${pharmacy.location.lng}`;
                    window.open(url, '_blank');
                    showToast('جاري فتح خرائط Google...', 'info');
                    closePharmacyModal();
                }
            };
            
            document.getElementById('pharmacyModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            if (state.isMobile && state.isSidebarOpen) {
                closeSidebar();
            }
        }

        function closePharmacyModal() {
            document.getElementById('pharmacyModal').style.display = 'none';
            document.body.style.overflow = '';
        }

        // ==============================================
        // عرض أحدث الصيدليات
        // ==============================================
        function renderRecentPharmacies(limit = 5) {
            const container = document.getElementById('recentPharmaciesList');
            
            const sorted = [...state.pharmacies]
                .filter(p => p && p.registeredAt)
                .sort((a, b) => new Date(b.registeredAt) - new Date(a.registeredAt))
                .slice(0, limit);
            
            if (sorted.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-muted);">لا توجد صيدليات مسجلة حديثاً</p>';
                return;
            }
            
            let html = '';
            sorted.forEach(pharmacy => {
                html += `
                    <div class="pharmacy-card" data-id="${pharmacy.id}">
                        <div class="pharmacy-name">
                            <h4>${pharmacy.name}</h4>
                            <span style="font-size: 0.8rem; color: var(--text-muted);">
                                <i class="fas fa-clock"></i> ${new Date(pharmacy.registeredAt).toLocaleDateString('ar-SA')}
                            </span>
                        </div>
                        <div class="pharmacy-address">
                            <i class="fas fa-map-marker-alt"></i>
                            ${pharmacy.address || 'عنوان غير متوفر'}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            container.querySelectorAll('.pharmacy-card').forEach(card => {
                card.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    showPharmacyDetails(id);
                });
            });
        }

        // ==============================================
        // اقتراحات البحث
        // ==============================================
        const commonMedicines = [
            'أموكسيسيلين', 'ميتفورمين', 'فينتولين', 'أيبوبروفين', 'باراسيتامول',
            'أتورفاستاتين', 'أوميبرازول', 'ليفوثيروكسين', 'أسبرين', 'لوسارتان'
        ];

        function showSuggestions(query) {
            const container = document.getElementById('searchSuggestions');
            
            if (!query.trim()) {
                container.style.display = 'none';
                return;
            }
            
            const filtered = commonMedicines.filter(med => 
                med.includes(query) || query.includes(med)
            ).slice(0, 5);
            
            if (filtered.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            let html = '';
            filtered.forEach(med => {
                html += `
                    <div class="search-suggestion-item" style="padding: 12px 16px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-pills" style="color: var(--primary-color);"></i>
                        <span>${med}</span>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            container.style.display = 'block';
            
            container.querySelectorAll('.search-suggestion-item').forEach(item => {
                item.addEventListener('click', function() {
                    const med = this.querySelector('span').textContent;
                    document.getElementById('medicineSearch').value = med;
                    container.style.display = 'none';
                    searchMedicine(med);
                });
            });
        }

        // ==============================================
        // الإشعارات
        // ==============================================
        function showToast(message, type = 'info') {
            const toast = document.getElementById('modernToast');
            const icon = toast.querySelector('.toast-icon i');
            const title = toast.querySelector('.toast-title');
            const msg = toast.querySelector('.toast-message');
            
            let bgColor, iconColor, iconClass, titleText;
            
            if (type === 'success') {
                bgColor = '#dcfce7';
                iconColor = '#166534';
                iconClass = 'fa-check-circle';
                titleText = 'تم بنجاح';
            } else if (type === 'error') {
                bgColor = '#fee2e2';
                iconColor = '#991b1b';
                iconClass = 'fa-exclamation-circle';
                titleText = 'خطأ';
            } else if (type === 'warning') {
                bgColor = '#fef9c3';
                iconColor = '#854d0e';
                iconClass = 'fa-exclamation-triangle';
                titleText = 'تنبيه';
            } else {
                bgColor = '#e6f7ff';
                iconColor = '#0284c7';
                iconClass = 'fa-info-circle';
                titleText = 'معلومات';
            }
            
            toast.querySelector('.toast-icon').style.background = bgColor;
            toast.querySelector('.toast-icon i').style.color = iconColor;
            icon.className = `fas ${iconClass}`;
            title.textContent = titleText;
            msg.textContent = message;
            
            toast.classList.add('show');
            
            if (window.toastTimeout) clearTimeout(window.toastTimeout);
            window.toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ==============================================
        // شاشة التحميل
        // ==============================================
        function showLoading(message = 'جاري التحميل...') {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loadingScreen').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingScreen').style.display = 'none';
        }

        // ==============================================
        // تبديل اللغة
        // ==============================================
        function toggleLanguage() {
            const html = document.documentElement;
            const btn = document.getElementById('langToggleBtn');
            
            if (html.lang === 'ar') {
                html.lang = 'en';
                html.dir = 'ltr';
                btn.innerHTML = '<span style="font-size: 0.9rem;">AR</span>';
                document.querySelector('.slogan').textContent = 'Your medicine is never far away...';
                showToast('Switched to English', 'info');
            } else {
                html.lang = 'ar';
                html.dir = 'rtl';
                btn.innerHTML = '<span style="font-size: 0.9rem;">EN</span>';
                document.querySelector('.slogan').textContent = 'دواؤك أقرب مما تتخيل...';
                showToast('تم التبديل إلى العربية', 'info');
            }
        }

        // ==============================================
        // دوال مساعدة
        // ==============================================
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function togglePassword(input, icon) {
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'far fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'far fa-eye';
            }
        }

        // ==============================================
        // دوال عامة
        // ==============================================
        window.showPharmacyDetails = showPharmacyDetails;
        window.closePharmacyModal = closePharmacyModal;
        window.searchMedicine = searchMedicine;
    </script>
</body>
</html>
